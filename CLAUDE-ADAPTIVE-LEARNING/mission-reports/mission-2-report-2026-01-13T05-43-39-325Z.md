# Comprehensive Implementation Report: SchoolGenius Syllabus System

This report provides an exhaustive analysis of the Syllabus System within the SchoolGenius educational platform, extracted from the provided documentation. It covers the system's architecture, modes, processing logic, database schema, UI components, business rules, and specific implementation details.

---

## 1. Overview of the Syllabus System

The Syllabus System in SchoolGenius is designed to help students prepare for school topics in advance by scanning their school syllabi and generating personalized preparation schedules. It integrates AI-driven analysis (via Grok) to map syllabus content to curriculum topics and schedule prep lessons before the topics are taught in school. The system operates in three distinct modes, each catering to different levels of customization and data input.

---

## 2. The Three Syllabus Modes

The Syllabus System supports three operational modes as defined in the database table `syllabus_settings` with a `mode` column. These modes are:

### 2.1 Default Mode
- **Definition**: A pre-configured, standard syllabus schedule provided by SchoolGenius based on typical grade-level curricula.
- **Functionality**: This mode is used when no custom or scanned syllabus data is available. It serves as a fallback, ensuring that every student has a baseline prep schedule aligned with common educational standards for their grade level.
- **How It Works**: The system automatically assigns a default schedule of lessons based on the student's grade level (stored in the `children` or `learning_profiles` table). These lessons are populated into the `daily_schedule` table with `from_syllabus=true`.
- **Use Case**: Ideal for students or parents who have not uploaded a syllabus or customized a schedule, providing a "ready-to-go" solution.

### 2.2 Custom Mode
- **Definition**: Allows parents or students to manually define a personalized syllabus schedule tailored to specific needs or preferences.
- **Functionality**: Users can customize aspects such as subject ordering, daily/weekly goals, and potentially difficulty levels or specific topics. This mode overrides the Default Mode when activated.
- **How It Works**: Custom settings are stored in the `syllabus_settings` table under the `mode` column as 'custom'. Users define their schedule (though the specific UI for this is currently missing, see Section 6.5). The system then populates the `daily_schedule` table with lessons based on these custom inputs, marked with `from_syllabus=true`.
- **Use Case**: Suitable for homeschooling families or students with unique learning needs who require a tailored preparation schedule.

### 2.3 Scanned Mode (School Mode)
- **Definition**: Utilizes a scanned school syllabus to generate a personalized prep schedule based on the actual topics and dates provided by the school.
- **Functionality**: This mode takes precedence over both Default and Custom Modes when a syllabus is scanned. It uses AI (Grok) to analyze the syllabus content, map topics to the curriculum, and schedule prep lessons 1-3 days before the school teaches them.
- **How It Works**: A scanned syllabus is uploaded via the Scan API, processed by the `analyze-syllabus` Edge Function, and saved to the `kid_scanned_docs` table with `doc_type='syllabus'`. The extracted topics and dates are used to generate prep lessons in the `daily_schedule` table, marked with `from_syllabus=true`.
- **Use Case**: Ideal for students who want to align their preparation directly with their school's teaching schedule, ensuring they are ahead of classroom instruction.

---

## 3. Mode Interaction & Priority Logic

### 3.1 Interaction Between Modes
- The three modes interact hierarchically based on user input and data availability. The system checks for the presence of a scanned syllabus first, then custom settings, and falls back to the default if neither is available.
- **Priority Order**:
  1. **Scanned Mode**: Highest priority. If a syllabus has been scanned and processed, it overrides both Custom and Default Modes. This ensures that the prep schedule aligns with the actual school curriculum.
  2. **Custom Mode**: Medium priority. If no scanned syllabus exists but a custom schedule has been defined, it overrides the Default Mode.
  3. **Default Mode**: Lowest priority. Used when neither a scanned syllabus nor a custom schedule is available.
- **Precedence Timing**: The system evaluates mode precedence at the time of schedule generation or when viewing the syllabus page (`/kid/[id]/syllabus`). If a new syllabus is scanned, it immediately takes precedence and regenerates the prep schedule.
- **Conflict Handling**: Conflicts are resolved by the priority order. For example, if a custom schedule exists but a syllabus is scanned, the scanned data overrides the custom settings in the `daily_schedule` table. There is no mechanism mentioned for merging or partial overrides; it's a full replacement based on the active mode.
- **Specific Rules**: The documentation indicates that the logic for Scanned Mode to override is implemented (`syllabus_settings` table supports this), but no detailed decision tree for edge cases (e.g., partial syllabus scans or invalid dates) is provided.

---

## 4. Scanned Syllabus Processing

### 4.1 Process Flow for Generating Prep Lessons
- **Step 1: Scanning**: A student or parent uploads a syllabus image or photo via the scan page (`/kid/[id]/scan`) using the Scan API Extension (`app/api/scan-document/route.ts`).
- **Step 2: Text Extraction**: The API uploads the image to storage, calls Gemini to extract text, and saves the document to the `kid_scanned_docs` table with `doc_type='syllabus'`, including fields like `image_url` and `extracted_text`.
- **Step 3: Detection**: The system detects the document type as 'syllabus' and triggers the `analyze-syllabus` Edge Function (`supabase/functions/analyze-syllabus/index.ts`).
- **Step 4: AI Analysis**: The Edge Function:
  - Retrieves the student's grade level (likely from `children` or `learning_profiles` table).
  - Calls Grok AI with the extracted syllabus text and grade context.
  - Analyzes the syllabus to map topics to the curriculum.
  - Generates prep lessons scheduled 1-3 days before the school teaches the topic.
- **Step 5: Storage**: The generated lessons are inserted into the `daily_schedule` table with `from_syllabus=true`, including fields like `date`, `subject_code`, `title`, `description`, and `estimated_minutes`.
- **Step 6: Display**: The prep schedule is displayed on the Syllabus Page (`app/kid/[id]/syllabus/page.tsx`) grouped by week.

### 4.2 Timing of Prep Lessons
- **When They Appear**: Prep lessons are scheduled to appear 1-3 days before the topic is taught in school, as determined by the dates extracted from the syllabus.
- **Algorithm for Timing**: The `analyze-syllabus` Edge Function parses dates from the syllabus text (e.g., "Week of January 20" or "January 22") and schedules lessons accordingly. The exact algorithm for handling ambiguous dates or timezone issues is not detailed, but troubleshooting notes suggest potential issues with date interpretation by Grok.
- **Parsing Mechanism**: Grok AI interprets the syllabus text to extract dates and topics. If dates are unclear, it may misinterpret them, requiring prompt adjustments or better date format handling (as noted in troubleshooting section of `SYLLABUS-DEPLOYMENT-GUIDE.md`).

### 4.3 Edge Function
- The `analyze-syllabus` Edge Function (`supabase/functions/analyze-syllabus/index.ts`) is responsible for processing scanned syllabi. It uses the Grok API (with `XAI_API_KEY` environment variable) to analyze text, map curriculum topics, and generate the prep schedule.

---

## 5. Custom Mode Details

### 5.1 Customization Capabilities
- **What Can Be Customized**: Parents or students can define subject ordering, set daily/weekly goals per subject, and potentially adjust other parameters like difficulty (though not explicitly confirmed in documentation). This is inferred from the planned "Custom Syllabus Editor" in `COMPREHENSIVE-GAP-ANALYSIS.md`.
- **How It Works**: Customization is intended to be done via a UI (currently missing), where users can drag-and-drop subjects or set goals. Once saved, these settings update the `syllabus_settings` table with `mode='custom'` and populate the `daily_schedule` table accordingly.

### 5.2 Storage
- Custom settings are stored in the `syllabus_settings` table, with the `mode` column set to 'custom'. Specific fields for storing custom schedules (e.g., subject order or goals) are not detailed in the provided schema but are implied to exist or be planned.

### 5.3 UI for Customization
- **Current Status**: The UI for customization is not implemented. The documentation (`COMPREHENSIVE-GAP-ANALYSIS.md`) notes the absence of a "Custom Syllabus Editor" page and mode switcher UI, which are critical for enabling this mode.

---

## 6. UI Elements Needed

### 6.1 Pages and Components
- **Syllabus Page** (`app/kid/[id]/syllabus/page.tsx`):
  - Displays the weekly prep schedule.
  - Shows lessons grouped by week with headers like "Week of [date]".
  - Includes lesson cards with details: Date, Subject code, Title, Description, Estimated time, and a "Start" button.
  - Shows a "Scan Syllabus Now" prompt if no syllabus exists.
- **Scan Page** (`app/kid/[id]/scan/page.tsx`):
  - Allows uploading of syllabus images or taking photos.
  - Includes a dropdown to select document type as "Syllabus".
  - Provides "Scan & Analyze" button to trigger processing.
- **Parent Dashboard** (partially implemented in `/dashboard/page.tsx`):
  - Needs a "Scan" button per child to access the scan feature.
  - Needs a "View Syllabus" link per child to see prep schedules.

### 6.2 Mode Switching Interface
- **Where**: Mode switching should occur in the Parent Dashboard via a dropdown or toggle.
- **How**: A confirmation dialog (e.g., "Switch to Custom Mode?") should appear to confirm the switch, explaining what each mode does.
- **Current Status**: Not implemented; listed as a critical gap in `COMPREHENSIVE-GAP-ANALYSIS.md`.

### 6.3 Mode Display
- **Indicator Badge**: A visual badge should display the current mode on the Syllabus Page (e.g., "DEFAULT MODE", "CUSTOM MODE", "SCHOOL MODE") with color coding (Blue for Default, Purple for Custom, Green for School).
- **Current Status**: Not implemented; planned in `COMPREHENSIVE-GAP-ANALYSIS.md`.

### 6.4 Controls for Each Mode
- **Default Mode**: No specific controls; it's a passive fallback.
- **Custom Mode**: Needs a "Custom Syllabus Editor" with drag-and-drop subject ordering, goal setting, a "Save Custom Schedule" button, and a preview feature.
- **Scanned Mode**: Needs a "Scan Syllabus Now" button on the Syllabus Page and integration with the Scan Page for uploads.

---

## 7. Database Schema

### 7.1 Relevant Tables
The Syllabus System relies on the following tables, as detailed in `SYLLABUS-DEPLOYMENT-GUIDE.md` and `COMPREHENSIVE-GAP-ANALYSIS.md`:

- **syllabus_settings**:
  - Stores mode configuration for each student.
  - Fields:
    - `mode`: Text ('default', 'custom', 'school') - Indicates the active mode.
    - Other fields for custom settings are implied but not specified.
- **daily_schedule**:
  - Stores the generated prep lessons.
  - Fields:
    - `id`: UUID - Unique identifier.
    - `child_id`: UUID - Links to the student.
    - `date`: Date - Scheduled date for the lesson.
    - `order_index`: Integer - Order of lessons on a given date.
    - `lesson_type`: Text - Set to "prep" for syllabus lessons.
    - `subject_code`: Text - Subject identifier (e.g., MATH, READING).
    - `title`: Text - Lesson title.
    - `description`: Text - Lesson details.
    - `estimated_minutes`: Integer - Time estimate for completion.
    - `completed`: Boolean - Completion status.
    - `from_syllabus`: Boolean - Set to TRUE for syllabus-generated lessons.
    - `created_at`: Timestamp - Creation time.
- **kid_scanned_docs**:
  - Stores scanned syllabus documents.
  - Fields:
    - `id`: UUID - Unique identifier.
    - `student_id`: UUID - Links to the student.
    - `doc_type`: Text - Set to "syllabus" for syllabus documents.
    - `image_url`: Text - URL of the uploaded image.
    - `extracted_text`: Text - Text extracted by Gemini.
    - `ai_summary`: Text - AI-generated summary (if applicable).
    - `subject`: Text - Subject of the document (if identified).
    - `created_at`: Timestamp - Creation time.

### 7.2 Mode Differentiation
- Modes are differentiated in the `syllabus_settings` table via the `mode` column. The value determines which logic the system uses to populate `daily_schedule`:
  - 'default': Uses pre-defined curriculum data.
  - 'custom': Uses user-defined settings.
  - 'school': Uses data from scanned syllabi in `kid_scanned_docs`.

---

## 8. Business Rules

### 8.1 Mode Switching Rules
- **Switching**: Parents can switch modes via a UI (not yet implemented). Switching requires confirmation to prevent accidental changes.
- **Validation**: No specific validation rules are mentioned, but it's implied that switching to Scanned Mode requires a valid scanned syllabus in `kid_scanned_docs`.
- **Persistence**: Mode changes persist across sessions, stored in `syllabus_settings`.

### 8.2 Permission Differences
- **Parent vs. Kid**: Mode switching and customization are likely restricted to parents, especially for younger students (K-2), as part of age-based permissions planned in `COMPREHENSIVE-GAP-ANALYSIS.md`. Kids may view the syllabus but not modify modes.
- **Grade-Level Restrictions**: No explicit restrictions are mentioned for syllabus modes, but age-based permissions (e.g., K-2 requiring heavy parent control) may apply to mode switching or customization access.

### 8.3 Other Rules
- **Prep Timing**: Lessons must be scheduled 1-3 days before school teaching dates in Scanned Mode to ensure preparation.
- **Data Persistence**: All syllabus-generated lessons in `daily_schedule` must persist across page refreshes and app restarts, as noted in success criteria.

---

## 9. Implementation Details

### 9.1 Code References
- **Scan API Extension**: `app/api/scan-document/route.ts`
  - Handles syllabus upload, text extraction via Gemini, and triggers Grok analysis.
  - Logs messages like "ðŸ“‹ Syllabus detected - calling Grok..." and "âœ… Generated X prep lessons".
- **Grok Edge Function**: `supabase/functions/analyze-syllabus/index.ts`
  - Analyzes syllabus text, maps topics, generates prep lessons 1-3 days before school dates, and inserts into `daily_schedule`.
  - Requires `XAI_API_KEY` environment variable for Grok API access.
- **Syllabus Page**: `app/kid/[id]/syllabus/page.tsx`
  - Displays the weekly prep schedule with lesson cards and "Scan Syllabus Now" prompt if no syllabus exists.
- **Scan Page**: `app/kid/[id]/scan/page.tsx`
  - Interface for uploading syllabus images and selecting document type.

### 9.2 API Endpoints
- **Scan Document API**: `/api/scan-document`
  - Used for uploading and processing syllabus images.
  - Integrates with Gemini for text extraction and triggers the `analyze-syllabus` Edge Function for syllabus-specific processing.

### 9.3 Edge Functions
- **analyze-syllabus**: Deployed via Supabase, located at `supabase/functions/analyze-syllabus/index.ts`.
  - Deployment command: `supabase functions deploy analyze-syllabus --project-ref nnwvzuvebcqrpjuqjlzb`.
  - Requires environment variables: `XAI_API_KEY`, `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`.
  - Logs available in Supabase Dashboard under Edge Functions â†’ Logs.

### 9.4 Deployment and Testing
- **Deployment Steps** (from `SYLLABUS-DEPLOYMENT-GUIDE.md`):
  1. Deploy Edge Function using `deploy-analyze-syllabus.bat` or manual command.
  2. Set `XAI_API_KEY` in Supabase Dashboard â†’ Edge Functions â†’ Secrets.
  3. Verify deployment status as "Active" in Supabase Dashboard.
- **Testing Workflow**:
  - Scan a syllabus at `http://localhost:3000/kid/[kid-id]/scan`.
  - Check database entries in `kid_scanned_docs` and `daily_schedule` via SQL queries.
  - View schedule at `http://localhost:3000/kid/[kid-id]/syllabus`.
- **Troubleshooting**:
  - Common issues include "Grok API error: 401 Unauthorized" (fix: set valid `XAI_API_KEY`), "Grok returned invalid JSON" (fix: check logs, adjust prompt), and incorrect dates (fix: improve date format handling in Grok prompt).

### 9.5 System Flow Diagram
From `SYLLABUS-DEPLOYMENT-GUIDE.md`:
```
1. Kid scans syllabus
   â†“
2. app/api/scan-document/route.ts
   - Uploads image to storage
   - Calls Gemini to extract text
   - Saves to kid_scanned_docs
   â†“
3. Detects docType === 'syllabus'
   â†“
4. Calls analyze-syllabus Edge Function
   - Gets child's grade level
   - Calls Grok with syllabus text
   - Parses Grok's prep lesson suggestions
   - Inserts into daily_schedule
   â†“
5. Kid views /kid/[id]/syllabus
   - Queries daily_schedule where from_syllabus=true
   - Displays weekly prep schedule
   â†“
6. Kid clicks "Start" on a lesson
   - Goes to /kid/[id] dashboard
   - Can access the prep lesson
```

### 9.6 Future Enhancements
From `SYLLABUS-DEPLOYMENT-GUIDE.md`:
- Add Claude analysis for scanned homework/tests.
- Create a parent dashboard for viewing all scanned documents.
- Implement calendar integration for test dates.
- Add notifications for upcoming prep lessons.

---

## 10. Conclusion

The SchoolGenius Syllabus System is a robust framework for personalized learning preparation, featuring three modes (Default, Custom, Scanned) with a clear priority hierarchy.